{"version":3,"sources":["file:///Users/feiwang/NewProject_4/assets/resources/scripts/login/loginModel.ts"],"names":["_decorator","basePageModel","loginView","GlobalConfig","ccclass","property","walletType","walletChain","loginUrls","firstLoginCheck","tgLogin","pwdLogin","loginModel","Boolean","start","view","getComponent","isUseMock","window","Telegram","WebApp","initDataUnsafe","query_id","user","id","first_name","last_name","language_code","allows_write_to_pm","photo_url","auth_date","hash","setPosition","isFirst","checkLoginFirst","controlLoginTypeBtnsVisible","update","deltaTime","isFirstLogin","axios","post","data","firstLogin","error","console","log","loginData","authDate","firstName","lastName","loginChannel","photoUrl","username","token","_instance","routeToHome","veteranLogin","checkVeteranInput","showVeteranError","accountUserName","getAccountInputString","password","getPasswordInputString"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node } from \"cc\";\nimport { basePageModel } from \"../common/basePageModel\";\nimport { loginView } from \"./loginView\";\nimport { GlobalConfig } from \"../home/GlobalConfig\";\nimport _ from \"lodash\";\nconst { ccclass, property } = _decorator;\n\nexport interface AxiosResponse<T = any, D = any> {\n  data: T;\n  status: number;\n  statusText: string;\n  headers: any;\n  config: any;\n  request?: any;\n}\n\ndeclare global {\n  interface Window {\n    axios: {\n      post<T = any, R = AxiosResponse<T>, D = any>(\n        url: string,\n        data?: D,\n        config?: any\n      ): Promise<R>;\n    };\n    startCanvas: any;\n    Telegram: any;\n  }\n}\n\nexport enum walletType {}\n\nexport enum walletChain {}\n\nexport const loginUrls = {\n  firstLoginCheck: \"https://api.infinitytest.cc/api/v1/user/auth/first_login\",\n  tgLogin: \"https://api.infinitytest.cc/api/v1/user/auth/tg_login\",\n  pwdLogin: \"https://api.infinitytest.cc/api/v1/user/auth/pwd_login\",\n};\n\nexport interface firstLoginCheckDataType {\n  id: number;\n}\n\nexport interface firstLoginCheckResponseType {\n  code: string;\n  data: {\n    firstLogin: true;\n  };\n  message: string;\n}\n\nexport interface tgLoginDataType {\n  authDate?: number;\n  firstName?: string;\n  hash?: string;\n  id: number;\n  inviteCode?: string;\n  lastName?: string;\n  loginChannel?: \"GAME_LOBBY\";\n  photoUrl?: string;\n  username?: string;\n}\n\nexport interface tgLoginResponseType {\n  code: string;\n  data: {\n    avatar: string;\n    email: string;\n    expiration: number;\n    gamePoint: number;\n    inviteCode: string;\n    isNewUser: true;\n    isSetPwd: true;\n    token: string;\n    totalPoint: 0;\n    userId: number;\n    userName: string;\n    walletAddress: string;\n    walletChain: \"ETH\";\n    walletType: \"METAMASK\";\n  };\n  message: string;\n}\n\nexport interface pwdLoginDataType {\n  accountUserName: string;\n  authDate?: number;\n  firstName?: string;\n  hash?: string;\n  id: number;\n  inviteCode?: string;\n  lastName?: string;\n  loginChannel?: \"GAME_LOBBY\";\n  password: string;\n  photoUrl?: string;\n  username?: string;\n}\n\nexport interface pwdLoginResponseType {\n  code: string;\n  data: {\n    avatar: string;\n    email: string;\n    expiration: number;\n    gamePoint: number;\n    inviteCode: string;\n    isNewUser: true;\n    isSetPwd: true;\n    token: string;\n    userId: number;\n    userName: string;\n    walletAddress: string;\n    walletChain: \"ETH\";\n    walletType: \"METAMASK\";\n  };\n  message: string;\n}\n\n@ccclass(\"loginModel\")\nexport class loginModel extends basePageModel {\n  @property(Boolean)\n  isUseMock: boolean = false;\n\n  loginView: loginView;\n  async start() {\n    this.loginView = this.view.getComponent(loginView);\n    if (this.isUseMock) {\n      window.Telegram.WebApp.initDataUnsafe = {\n        query_id: \"AAF7JpQPAwAAAHsmlA8spImV\",\n        user: {\n          id: 6703818363,\n          first_name: \"fei\",\n          last_name: \"wang\",\n          language_code: \"zh-hans\",\n          allows_write_to_pm: true,\n          photo_url:\n            \"https://t.me/i/userpic/320/X12MAmP3LRE86nyBFSTIu7gHQ3DMMFyJG_guP3PXbe1ra9sUBt3UL5wqLO7SUrl6.svg\",\n        },\n        auth_date: \"1726639117\",\n        hash: \"8346cc12bf427171ceb09f9a75f63d00f37edb017c921641d6036e9758abf134\",\n      };\n    }\n    this.view.setPosition(0, 0);\n    const isFirst = await this.checkLoginFirst();\n    if (isFirst) {\n      //展示登录页面\n      this.loginView.controlLoginTypeBtnsVisible(true);\n    } else {\n      await this.tgLogin();\n    }\n  }\n\n  update(deltaTime: number) {}\n\n  async checkLoginFirst() {\n    try {\n      const isFirstLogin = await window.axios.post<firstLoginCheckResponseType>(\n        loginUrls.firstLoginCheck,\n        {\n          id: this.isUseMock\n            ? 6703818363\n            : window.Telegram.WebApp.initDataUnsafe.user.id,\n        }\n      );\n      return isFirstLogin.data.data.firstLogin;\n    } catch (error) {\n      console.log(error);\n    }\n  }\n\n  async tgLogin() {\n    try {\n      const loginData = await window.axios.post<tgLoginResponseType>(\n        loginUrls.tgLogin,\n        {\n          authDate: 0,\n          firstName: `${\n            this.isUseMock\n              ? \"fei\"\n              : window.Telegram.WebApp.initDataUnsafe.user.first_name\n          }`,\n          hash: `${\n            this.isUseMock\n              ? \"8346cc12bf427171ceb09f9a75f63d00f37edb017c921641d6036e9758abf134\"\n              : window.Telegram.WebApp.initDataUnsafe.hash\n          }`,\n          id: this.isUseMock\n            ? 6703818363\n            : window.Telegram.WebApp.initDataUnsafe.user.id,\n          lastName: `${\n            this.isUseMock\n              ? \"wang\"\n              : window.Telegram.WebApp.initDataUnsafe.user.last_name\n          }`,\n          loginChannel: \"GAME_LOBBY\",\n          photoUrl: `${\n            this.isUseMock\n              ? \"\"\n              : window.Telegram.WebApp.initDataUnsafe.user.photo_url\n          }`,\n          username: \"\",\n        }\n      );\n\n      if (loginData?.data?.data?.token) {\n        //登录成功\n        GlobalConfig._instance.token = loginData?.data?.data?.token;\n        this.loginView.routeToHome();\n      }\n    } catch (error) {\n      console.log(error);\n    }\n  }\n\n  async veteranLogin() {\n    if (this.loginView.checkVeteranInput()) {\n      this.loginView.showVeteranError(true);\n    }\n\n    try {\n      const loginData = await window.axios.post<pwdLoginResponseType>(\n        loginUrls.pwdLogin,\n        {\n          accountUserName: this.loginView.getAccountInputString(),\n          authDate: 0,\n          firstName: `${\n            this.isUseMock\n              ? \"fei\"\n              : window.Telegram.WebApp.initDataUnsafe.user.first_name\n          }`,\n          hash: `${\n            this.isUseMock\n              ? \"8346cc12bf427171ceb09f9a75f63d00f37edb017c921641d6036e9758abf134\"\n              : window.Telegram.WebApp.initDataUnsafe.hash\n          }`,\n          id: this.isUseMock\n            ? 6703818363\n            : window.Telegram.WebApp.initDataUnsafe.user.id,\n          lastName: `${\n            this.isUseMock\n              ? \"wang\"\n              : window.Telegram.WebApp.initDataUnsafe.user.last_name\n          }`,\n          loginChannel: \"GAME_LOBBY\",\n          password: this.loginView.getPasswordInputString(),\n          photoUrl: `${\n            this.isUseMock\n              ? \"https://t.me/i/userpic/320/X12MAmP3LRE86nyBFSTIu7gHQ3DMMFyJG_guP3PXbe1ra9sUBt3UL5wqLO7SUrl6.svg\"\n              : window.Telegram.WebApp.initDataUnsafe.user.photo_url\n          }`,\n          username: \"\",\n        }\n      );\n\n      if (loginData?.data?.data?.token) {\n        GlobalConfig._instance.token = loginData?.data?.data?.token;\n        this.loginView.routeToHome();\n      }\n    } catch (error) {\n      console.log(error);\n    }\n  }\n}\n"]}