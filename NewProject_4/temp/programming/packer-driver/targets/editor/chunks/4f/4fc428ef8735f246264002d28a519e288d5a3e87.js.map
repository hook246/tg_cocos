{"version":3,"sources":["file:///Users/feiwang/NewProject_4/node_modules/axios/lib/helpers/AxiosTransformStream.js"],"names":["AxiosTransformStream","stream","utils","kInternals","Symbol","Transform","constructor","options","toFlatObject","maxRate","chunkSize","minChunkSize","timeWindow","ticksRate","samplesCount","prop","source","isUndefined","readableHighWaterMark","internals","bytesSeen","isCaptured","notifiedBytesLoaded","ts","Date","now","bytes","onReadCallback","on","event","_read","size","_transform","chunk","encoding","callback","divider","bytesThreshold","Math","max","pushChunk","_chunk","_callback","Buffer","byteLength","emit","push","process","nextTick","transformChunk","chunkRemainder","maxChunkSize","bytesLeft","passed","setTimeout","subarray","transformNextChunk","err"],"mappings":"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","sourcesContent":["'use strict';\n\nimport stream from 'stream';\nimport utils from '../utils.js';\n\nconst kInternals = Symbol('internals');\n\nclass AxiosTransformStream extends stream.Transform{\n  constructor(options) {\n    options = utils.toFlatObject(options, {\n      maxRate: 0,\n      chunkSize: 64 * 1024,\n      minChunkSize: 100,\n      timeWindow: 500,\n      ticksRate: 2,\n      samplesCount: 15\n    }, null, (prop, source) => {\n      return !utils.isUndefined(source[prop]);\n    });\n\n    super({\n      readableHighWaterMark: options.chunkSize\n    });\n\n    const internals = this[kInternals] = {\n      timeWindow: options.timeWindow,\n      chunkSize: options.chunkSize,\n      maxRate: options.maxRate,\n      minChunkSize: options.minChunkSize,\n      bytesSeen: 0,\n      isCaptured: false,\n      notifiedBytesLoaded: 0,\n      ts: Date.now(),\n      bytes: 0,\n      onReadCallback: null\n    };\n\n    this.on('newListener', event => {\n      if (event === 'progress') {\n        if (!internals.isCaptured) {\n          internals.isCaptured = true;\n        }\n      }\n    });\n  }\n\n  _read(size) {\n    const internals = this[kInternals];\n\n    if (internals.onReadCallback) {\n      internals.onReadCallback();\n    }\n\n    return super._read(size);\n  }\n\n  _transform(chunk, encoding, callback) {\n    const internals = this[kInternals];\n    const maxRate = internals.maxRate;\n\n    const readableHighWaterMark = this.readableHighWaterMark;\n\n    const timeWindow = internals.timeWindow;\n\n    const divider = 1000 / timeWindow;\n    const bytesThreshold = (maxRate / divider);\n    const minChunkSize = internals.minChunkSize !== false ? Math.max(internals.minChunkSize, bytesThreshold * 0.01) : 0;\n\n    const pushChunk = (_chunk, _callback) => {\n      const bytes = Buffer.byteLength(_chunk);\n      internals.bytesSeen += bytes;\n      internals.bytes += bytes;\n\n      internals.isCaptured && this.emit('progress', internals.bytesSeen);\n\n      if (this.push(_chunk)) {\n        process.nextTick(_callback);\n      } else {\n        internals.onReadCallback = () => {\n          internals.onReadCallback = null;\n          process.nextTick(_callback);\n        };\n      }\n    }\n\n    const transformChunk = (_chunk, _callback) => {\n      const chunkSize = Buffer.byteLength(_chunk);\n      let chunkRemainder = null;\n      let maxChunkSize = readableHighWaterMark;\n      let bytesLeft;\n      let passed = 0;\n\n      if (maxRate) {\n        const now = Date.now();\n\n        if (!internals.ts || (passed = (now - internals.ts)) >= timeWindow) {\n          internals.ts = now;\n          bytesLeft = bytesThreshold - internals.bytes;\n          internals.bytes = bytesLeft < 0 ? -bytesLeft : 0;\n          passed = 0;\n        }\n\n        bytesLeft = bytesThreshold - internals.bytes;\n      }\n\n      if (maxRate) {\n        if (bytesLeft <= 0) {\n          // next time window\n          return setTimeout(() => {\n            _callback(null, _chunk);\n          }, timeWindow - passed);\n        }\n\n        if (bytesLeft < maxChunkSize) {\n          maxChunkSize = bytesLeft;\n        }\n      }\n\n      if (maxChunkSize && chunkSize > maxChunkSize && (chunkSize - maxChunkSize) > minChunkSize) {\n        chunkRemainder = _chunk.subarray(maxChunkSize);\n        _chunk = _chunk.subarray(0, maxChunkSize);\n      }\n\n      pushChunk(_chunk, chunkRemainder ? () => {\n        process.nextTick(_callback, null, chunkRemainder);\n      } : _callback);\n    };\n\n    transformChunk(chunk, function transformNextChunk(err, _chunk) {\n      if (err) {\n        return callback(err);\n      }\n\n      if (_chunk) {\n        transformChunk(_chunk, transformNextChunk);\n      } else {\n        callback(null);\n      }\n    });\n  }\n}\n\nexport default AxiosTransformStream;\n"]}