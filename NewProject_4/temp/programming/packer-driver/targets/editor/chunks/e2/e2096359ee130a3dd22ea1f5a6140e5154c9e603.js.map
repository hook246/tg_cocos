{"version":3,"sources":["file:///Users/feiwang/tg_cocos/NewProject_4/assets/resources/scripts/draw/drawModel.ts"],"names":["_decorator","basePageModel","drawView","GlobalData","ccclass","property","walletUrls","bindWallet","isProduction","unbindWallet","queryBindWallet","drawModel","drawPage","account","tonConnectUI","start","window","bindUxuyWallet","view","getComponent","console","log","manifest","TON_CONNECT_UI","TonConnectUI","manifestUrl","uiPreferences","update","deltaTime","bindTonWallet","connected","disconnect","onStatusChange","walletAndwalletInfo","wallet_address","controlConnectWalletBtnsVisible","home","getChildByName","active","walletInfo","axios","post","walletAddress","address","walletChain","chain","headers","token","setWalletInfo","openModal","initData","getWalletInfo","uxuyethereum","_account","chainName","uxuyWalletConnect","error","unBindWallet","controlUnbindBtnVisible","controlBindBtnVisible","data","code","copyAddress","navigator","clipboard","writeText","string","then","Telegram","WebApp","showPopup","title","message","buttons","id","text","type","buttonId","catch","err"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node } from \"cc\";\nimport { basePageModel } from \"../common/basePageModel\";\nimport { AxiosResponse } from \"../login/loginModel\";\nimport { GlobalConfig } from \"../home/GlobalConfig\";\nimport { drawView } from \"./drawView\";\nimport GlobalData from '../home/GloabalClass'\nconst { ccclass, property } = _decorator;\n\ndeclare global {\n  interface Window {\n    axios: {\n      post<T = any, R = AxiosResponse<T>, D = any>(\n        url: string,\n        data?: D,\n        config?: any\n      ): Promise<R>;\n    };\n    startCanvas: any;\n    uxuyethereum: any;\n    uxuyWalletConnect: any;\n\n    bindUxuyWallet\n    TON_CONNECT_UI\n\n  }\n}\n\nexport const walletUrls = {\n  bindWallet: GlobalData.isProduction ? \"https://api.infinityg.ai/api/v1/user/info/edit/bindWallet\" : \"https://api.infinitytest.cc/api/v1/user/info/edit/bindWallet\",\n  unbindWallet: GlobalData.isProduction ? \"https://api.infinityg.ai/api/v1/user/info/edit/unbindWallet\":\n    \"https://api.infinitytest.cc/api/v1/user/info/edit/unbindWallet\",\n  queryBindWallet: GlobalData.isProduction ? \"https://api.infinityg.ai/api/v1/user/info/queryBindWallet\":\n    \"https://api.infinitytest.cc/api/v1/user/info/queryBindWallet\",\n};\n\nexport interface BindWalletData {\n  walletAddress: string;\n  walletChain: string;\n}\n\nexport interface BindWalletResponse {\n  code: string;\n  message: string;\n}\n\nexport interface UnbindWalletData {}\n\nexport interface UnbindWalletResponse {\n  code: string;\n  message: string;\n}\n\nexport interface QueryBindWalletData {}\n\nexport interface QueryBindWalletResponse {\n  code: string;\n  data: {\n    walletAddress: string;\n    walletChain: string;\n  };\n  message: string;\n}\n\n@ccclass(\"drawModel\")\nexport class drawModel extends basePageModel {\n  drawPage: drawView\n\n  account;\n  tonConnectUI;\n\n  async start() {\n    window.bindUxuyWallet = this.bindUxuyWallet\n    this.drawPage = this.view.getComponent(drawView)\n\n    console.log(\"INIT the tonconnect \", this.tonConnectUI);\n    //提供一个manifest的json文件记录一些标题图标等数据用于UI连接时的展示\n    const manifest = \"https://catoss.s3.ap-southeast-1.amazonaws.com/telegram/manifest.json\";\n    console.log(manifest);\n    //获得TON_CONNECT_UI的实例\n    this.tonConnectUI = new window.TON_CONNECT_UI.TonConnectUI({\n      manifestUrl: manifest,\n      uiPreferences: {\n        //这里可以配置主题\n        // theme: TON_CONNECT_UI.THEME.DARK,\n      },\n    });\n\n    // if(this.tonConnectUI.connected) {\n    //     //断开连接重新加载\n    //     console.log(\"Disconnect for connection reload\")\n    //     await this.tonConnectUI.disconnect();\n    // }\n  }\n\n  update(deltaTime: number) {}\n\n  async bindTonWallet() {\n    if(this.tonConnectUI.connected){\n      await this.tonConnectUI.disconnect();\n    }\n    this.tonConnectUI.onStatusChange(async (walletAndwalletInfo) => {\n      //连接状态改变监听事件\n      if(GlobalData.wallet_address){\n        return\n      }\n      console.log(\"change : \", walletAndwalletInfo);\n      this.account = walletAndwalletInfo;\n      this.drawPage.controlConnectWalletBtnsVisible(false)\n      this.drawPage.home.getChildByName('tap_btns').active = true\n      const walletInfo = await window.axios.post<BindWalletResponse>(\n        walletUrls.bindWallet,{\n          walletAddress: walletAndwalletInfo.account.address,\n          walletChain: walletAndwalletInfo.account.chain,\n        },{\n          headers: { \n              'Authorization': `Bearer ${GlobalData.token}`\n            }\n        }\n      );\n      this.drawPage.setWalletInfo(walletAndwalletInfo.account.address)\n    });\n    await this.tonConnectUI.openModal();\n  }\n\n  async initData(){\n    const walletInfo = await this.getWalletInfo()\n    if(walletInfo?.walletAddress){\n      this.drawPage.setWalletInfo(walletInfo?.walletAddress)\n    }\n  }\n\n  async bindUxuyWallet() {\n    try {\n      this.drawPage.controlConnectWalletBtnsVisible(false)\n      this.drawPage.home.getChildByName('tap_btns').active = true\n      let walletAddress\n      let walletChain\n      if(window.uxuyethereum._account.address){\n        walletAddress = window.uxuyethereum._account.address\n        walletChain = window.uxuyethereum._account.chainName\n      }else{\n        await window.uxuyWalletConnect()\n        walletAddress = window.uxuyethereum._account.address\n        walletChain = window.uxuyethereum._account.chainName\n      }\n      console.log('========',walletAddress, walletChain)\n      const walletInfo = await window.axios.post<BindWalletResponse>(\n        walletUrls.bindWallet,{\n          walletAddress: walletAddress,\n          walletChain: walletChain,\n        },{\n          headers: { \n              'Authorization': `Bearer ${GlobalData.token}`\n            }\n        }\n      );\n      this.drawPage.setWalletInfo(walletAddress)\n\n    } catch (error) {\n      \n    }\n  }\n\n  async unBindWallet() {\n    const walletInfo = await window.axios.post<UnbindWalletResponse>(\n      walletUrls.unbindWallet\n    ,{},{\n        headers: { \n              'Authorization': `Bearer ${GlobalData.token}`\n          }\n    });\n    this.drawPage.controlUnbindBtnVisible(false)\n    this.drawPage.controlBindBtnVisible(true)\n    GlobalData.wallet_address = null\n    return walletInfo?.data?.code;\n  }\n\n  async getWalletInfo() {\n    const walletInfo = await window.axios.post<QueryBindWalletResponse>(\n      walletUrls.queryBindWallet\n    ,{},{\n        headers: { \n              'Authorization': `Bearer ${GlobalData.token}`\n          }\n    });\n    return walletInfo?.data?.data;\n  }\n\n  async copyAddress(){\n    navigator.clipboard.writeText(this.drawPage.address.string).then(function() {\n      window.Telegram.WebApp.showPopup({\n        title: 'Copy Success', // 弹出窗口的标题\n        message: 'copy address success！', // 弹出窗口的消息内容\n        buttons: [\n          { id: 'btn2', text: 'Button 2', type: 'ok' }, // 'type' 可以是 'ok', 'close', 'cancel', 'default', 'destructive'\n          { id: 'btn3', text: 'Button 3', type: 'cancel' }\n        ]\n      }, (buttonId) => {\n        // 弹出窗口关闭时的回调函数\n        if (buttonId) {\n          console.log('User pressed button:', buttonId);\n        } else {\n          console.log('Popup was closed without pressing a button');\n        }\n      });\n    }).catch(err => {\n      window.Telegram.WebApp.showPopup({\n        title: 'Copy failed', // 弹出窗口的标题\n        message: 'copy address failed', // 弹出窗口的消息内容\n        buttons: [\n          { id: 'btn2', text: 'Button 2', type: 'ok' }, // 'type' 可以是 'ok', 'close', 'cancel', 'default', 'destructive'\n          { id: 'btn3', text: 'Button 3', type: 'cancel' }\n        ]\n      }, (buttonId) => {\n        // 弹出窗口关闭时的回调函数\n        if (buttonId) {\n          console.log('User pressed button:', buttonId);\n        } else {\n          console.log('Popup was closed without pressing a button');\n        }\n      });\n    });\n  }\n}\n"]}