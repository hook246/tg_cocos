{"version":3,"sources":["file:///Users/feiwang/NewProject_4/assets/resources/scripts/login/loginModel.ts"],"names":["_decorator","basePageModel","loginView","GlobalConfig","_","axios","ccclass","property","walletType","walletChain","loginUrls","firstLoginCheck","tgLogin","pwdLogin","loginModel","Boolean","start","console","log","view","getComponent","isUseMock","window","Telegram","WebApp","initDataUnsafe","setPosition","isFirst","checkLoginFirst","controlLoginTypeBtnsVisible","update","deltaTime","isFirstLogin","post","id","user","data","firstLogin","loginData","authDate","firstName","first_name","hash","lastName","last_name","loginChannel","photoUrl","photo_url","username","token","_instance","routeToHome","veteranLogin","checkVeteranInput","showVeteranError","accountUserName","getAccountInputString","password","getPasswordInputString"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node } from \"cc\";\nimport { basePageModel } from \"../common/basePageModel\";\nimport { loginView } from \"./loginView\";\nimport { GlobalConfig } from \"../home/GlobalConfig\";\nimport _ from 'lodash'\nimport axios from 'axios'\nconst { ccclass, property } = _decorator;\n\nexport interface AxiosResponse<T = any, D = any> {\n  data: T;\n  status: number;\n  statusText: string;\n  headers: any;\n  config: any;\n  request?: any;\n}\n\ndeclare global {\n  interface Window {\n    axios: {\n      post<T = any, R = AxiosResponse<T>, D = any>(\n        url: string,\n        data?: D,\n        config?: any\n      ): Promise<R>;\n    };\n    startCanvas: any;\n    Telegram: any;\n  }\n}\n\nexport enum walletType {}\n\nexport enum walletChain {}\n\nexport const loginUrls = {\n  firstLoginCheck: \"https://api.infinitytest.cc/api/v1/user/auth/first_login\",\n  tgLogin: \"https://api.infinitytest.cc/api/v1/user/auth/tg_login\",\n  pwdLogin: \"https://api.infinitytest.cc/api/v1/user/auth/pwd_login\",\n};\n\nexport interface firstLoginCheckDataType {\n  id: number;\n}\n\nexport interface firstLoginCheckResponseType {\n  code: string;\n  data: {\n    firstLogin: true;\n  };\n  message: string;\n}\n\nexport interface tgLoginDataType {\n  authDate?: number;\n  firstName?: string;\n  hash?: string;\n  id: number;\n  inviteCode?: string;\n  lastName?: string;\n  loginChannel?: \"GAME_LOBBY\";\n  photoUrl?: string;\n  username?: string;\n}\n\nexport interface tgLoginResponseType {\n  code: string;\n  data: {\n    avatar: string;\n    email: string;\n    expiration: number;\n    gamePoint: number;\n    inviteCode: string;\n    isNewUser: true;\n    isSetPwd: true;\n    token: string;\n    totalPoint: 0;\n    userId: number;\n    userName: string;\n    walletAddress: string;\n    walletChain: \"ETH\";\n    walletType: \"METAMASK\";\n  };\n  message: string;\n}\n\nexport interface pwdLoginDataType {\n  accountUserName: string;\n  authDate?: number;\n  firstName?: string;\n  hash?: string;\n  id: number;\n  inviteCode?: string;\n  lastName?: string;\n  loginChannel?: \"GAME_LOBBY\";\n  password: string;\n  photoUrl?: string;\n  username?: string;\n}\n\nexport interface pwdLoginResponseType {\n  code: string;\n  data: {\n    avatar: string;\n    email: string;\n    expiration: number;\n    gamePoint: number;\n    inviteCode: string;\n    isNewUser: true;\n    isSetPwd: true;\n    token: string;\n    userId: number;\n    userName: string;\n    walletAddress: string;\n    walletChain: \"ETH\";\n    walletType: \"METAMASK\";\n  };\n  message: string;\n}\n\n@ccclass(\"loginModel\")\nexport class loginModel extends basePageModel {\n    @property(Boolean)\n    isUseMock: boolean = false\n\n    loginView: loginView\n  async start() {\n    console.log('======',_,axios)\n    this.loginView = this.view.getComponent(loginView)\n    if(this.isUseMock){\n        window.Telegram.WebApp.initDataUnsafe = {\n            \"query_id\": \"AAF7JpQPAwAAAHsmlA8spImV\",\n            \"user\": {\n              \"id\": 6703818363,\n              \"first_name\": \"fei\",\n              \"last_name\": \"wang\",\n              \"language_code\": \"zh-hans\",\n              \"allows_write_to_pm\": true,\n              \"photo_url\": \"https://t.me/i/userpic/320/X12MAmP3LRE86nyBFSTIu7gHQ3DMMFyJG_guP3PXbe1ra9sUBt3UL5wqLO7SUrl6.svg\"\n            },\n            \"auth_date\": \"1726639117\",\n            \"hash\": \"8346cc12bf427171ceb09f9a75f63d00f37edb017c921641d6036e9758abf134\"\n          }\n    }\n    this.view.setPosition(0, 0)\n    const isFirst = await this.checkLoginFirst();\n    if (isFirst) {\n      //展示登录页面\n      this.loginView.controlLoginTypeBtnsVisible(true)\n    } else {\n      await this.tgLogin();\n    }\n  }\n\n  update(deltaTime: number) {}\n\n  async checkLoginFirst() {\n    const isFirstLogin = await window.axios.post<firstLoginCheckResponseType>(\n      loginUrls.firstLoginCheck,\n      {\n        id: window.Telegram.WebApp.initDataUnsafe.user.id,\n      }\n    );\n    return isFirstLogin.data.data.firstLogin;\n  }\n\n  async tgLogin() {\n    const loginData = await window.axios.post<tgLoginResponseType>(\n      loginUrls.tgLogin,\n      {\n        authDate: 0,\n        firstName: `${window.Telegram.WebApp.initDataUnsafe.user.first_name}`,\n        hash: `${window.Telegram.WebApp.initDataUnsafe.hash}`,\n        id: window.Telegram.WebApp.initDataUnsafe.user.id,\n        lastName: `${window.Telegram.WebApp.initDataUnsafe.user.last_name}`,\n        loginChannel: \"GAME_LOBBY\",\n        photoUrl: `${window.Telegram.WebApp.initDataUnsafe.user.photo_url}`,\n        username: ''\n      }\n    );\n\n    if (loginData?.data?.data?.token) {\n      //登录成功\n      GlobalConfig._instance.token = loginData?.data?.data?.token\n      this.loginView.routeToHome()\n    }\n  }\n\n  async veteranLogin(){\n    if(this.loginView.checkVeteranInput()){\n        this.loginView.showVeteranError(true)\n    }\n\n    const loginData = await window.axios.post<pwdLoginResponseType>(\n        loginUrls.pwdLogin,\n        {\n            accountUserName: this.loginView.getAccountInputString(),\n            authDate: 0,\n            firstName: `${window.Telegram.WebApp.initDataUnsafe.user.first_name}`,\n            hash: `${window.Telegram.WebApp.initDataUnsafe.hash}`,\n            id: window.Telegram.WebApp.initDataUnsafe.user.id,\n            lastName: window.Telegram.WebApp.initDataUnsafe.user.last_name,\n            loginChannel: \"GAME_LOBBY\",\n            password: this.loginView.getPasswordInputString(),\n            photoUrl: `${window.Telegram.WebApp.initDataUnsafe.user.photo_url}`,\n            username: ''\n        }\n      );\n\n      if(loginData?.data?.data?.token){\n        GlobalConfig._instance.token = loginData?.data?.data?.token\n        this.loginView.routeToHome()\n      }\n  }\n}\n"]}